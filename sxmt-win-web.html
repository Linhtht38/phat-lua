<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gợi ý 5 cặp (nhập tay 3 ngày trước)</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #101827;
      --border: #1f2937;
      --accent: #22d3ee;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #000;
      color: var(--text);
      min-height: 100vh;
      padding: 18px;
    }
    h1 { margin: 0 0 12px; font-size: 24px; letter-spacing: 0.2px; text-align: center; }
    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      align-items: start;
      max-width: 520px;
      margin: 0 auto;
      width: 100%;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .card h2 { margin: 0 0 10px; font-size: 17px; color: var(--accent); }
    label { display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted); }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0c1423;
      color: var(--text);
    }
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0c1423;
      color: var(--text);
      resize: vertical;
      font-family: "JetBrains Mono", "Consolas", monospace;
      font-size: 13px;
    }
    button {
      padding: 12px;
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--accent);
      background: rgba(34,211,238,0.12);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    button:hover { background: rgba(34,211,238,0.2); transform: translateY(-1px); }
    .muted { color: var(--muted); font-size: 13px; line-height: 1.4; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .small-note { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(56,189,248,0.16);
      color: #e0f2fe;
      border: 1px solid rgba(56,189,248,0.7);
      cursor: pointer;
      font-weight: 600;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, color 120ms ease;
    }
    .pill:hover { transform: translateY(-1px); background: rgba(56,189,248,0.24); }
    .pill.active { background: rgba(56,189,248,0.32); border-color: rgba(56,189,248,0.9); color: #f8fafc; }
    .pill.ready { background: rgba(34,197,94,0.3); border-color: rgba(34,197,94,0.85); color: #dcfce7; }
    .pill .count {
      background: rgba(15, 23, 42, 0.6);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 12px;
      color: #bae6fd;
      border: 1px solid rgba(56,189,248,0.5);
    }
    .pill.ready .count { color: #bbf7d0; border-color: rgba(34,197,94,0.7); }
    .collapsible { display: none; margin-top: 8px; }
    .collapsible.open { display: block; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <h1>Gợi ý 5 cặp Thống kê SXMT</h1>
  <div class="layout">
    <div class="card">
      <button id="btn-index">Thống kê SXMN</button>
    </div>

    <div class="card">
      <h2>Nhập ngày mục tiêu</h2>
      <label for="target-date">Ngày (dd/mm/yyyy):</label>
      <input type="text" id="target-date" placeholder="vd: 10/05/2025" value="10/05/2025" />
      <p class="muted" id="date-helper">D-1: ?, D-2: ?, D-3: ?</p>
      <p class="muted">Không dùng Excel. Bạn nhập tay kết quả 3 ngày trước theo đúng ngày hiển thị.</p>

      <h2 style="margin-top:12px;">Nhập tay 3 ngày trước</h2>
      <div class="grid2">
        <div>
          <button class="pill" id="btn-d3" type="button">D-3 <span class="count" id="count-d3">0</span></button>
          <div class="collapsible" id="panel-d3">
            <label id="label-d3" for="input-d3">D-3:</label>
            <textarea id="input-d3" placeholder="vd: 01,02 15 99"></textarea>
          </div>
        </div>
        <div>
          <button class="pill" id="btn-d2" type="button">D-2 <span class="count" id="count-d2">0</span></button>
          <div class="collapsible" id="panel-d2">
            <label id="label-d2" for="input-d2">D-2:</label>
            <textarea id="input-d2" placeholder="vd: 03 17 58 90"></textarea>
          </div>
        </div>
      </div>
      <div style="margin-top:10px;">
        <button class="pill" id="btn-d1" type="button">D-1 <span class="count" id="count-d1">0</span></button>
        <div class="collapsible" id="panel-d1">
          <label id="label-d1" for="input-d1">D-1:</label>
          <textarea id="input-d1" placeholder="vd: 05, 12 44 77 99"></textarea>
        </div>
      </div>
      <p class="small-note">Nhập số 2 chữ số, cách nhau bằng dấu phẩy/khoảng trắng/dòng mới. Ví dụ: 01,02 15 99</p>

      <h2 style="margin-top:12px;">Nạp nhanh từ Excel GitHub</h2>
      <label for="excel-url">Raw URL file xsmt_daily_duoi2so.xlsx:</label>
      <input type="text" id="excel-url" placeholder="https://raw.githubusercontent.com/.../xsmt_daily_duoi2so.xlsx" value="https://raw.githubusercontent.com/Linhtht38/phat-lua/main/xsmt_daily_duoi2so.xlsx" />
      <p class="small-note" id="excel-status">Tải trực tiếp từ raw GitHub, tự đổ D-3/D-2/D-1 theo ngày mục tiêu.</p>
      <button id="btn-load-excel" style="margin-top:8px;">Nạp Excel 3 ngày</button>

      <button id="btn-run" style="margin-top:12px;">Tính 5 cặp</button>
    </div>

    <div class="card">
      <h2>Kết quả</h2>
      <textarea id="output" readonly>Nhập ngày và 3 ngày trước, rồi bấm "Tính 5 cặp".</textarea>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    function parseDateDDMMYYYY(str) {
      const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(str.trim());
      if (!m) return null;
      const d = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10);
      const y = parseInt(m[3], 10);
      const date = new Date(y, mo - 1, d);
      if (date.getFullYear() !== y || date.getMonth() !== mo - 1 || date.getDate() !== d) return null;
      return date;
    }

    function formatDDMMYYYY(date) {
      const d = String(date.getDate()).padStart(2, "0");
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }

    function parseNums(raw) {
      if (!raw || !raw.trim()) return [];
      return raw
        .split(/[^0-9]+/)
        .filter(Boolean)
        .map(x => parseInt(x, 10) % 100)
        .filter(n => !Number.isNaN(n));
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function range(n) {
      return Array.from({ length: n }, (_, i) => i);
    }

    function sample(arr, k) {
      const copy = arr.slice();
      shuffle(copy);
      return copy.slice(0, k);
    }

    function toTextareaString(arr) {
      return arr.map(n => String(n).padStart(2, "0")).join(" ");
    }

    async function fetchExcel(url) {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Tải Excel lỗi (${resp.status})`);
      const ab = await resp.arrayBuffer();
      return XLSX.read(ab, { type: "array" });
    }

    function extractNumsForDate(wb, date) {
      const sheetName = String(date.getFullYear());
      const ws = wb.Sheets[sheetName];
      if (!ws) return [];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
      const target = formatDDMMYYYY(date);

      let start = -1;
      for (let i = 0; i < rows.length; i++) {
        const r = rows[i] || [];
        if (r[0] === "Káº¿t quáº£ XSMT" && String(r[1]).trim() === target) {
          start = i;
          break;
        }
      }
      if (start === -1) return [];

      const nums = [];
      for (let i = start + 2; i < rows.length; i++) {
        const r = rows[i] || [];
        if (r[0] === "Káº¿t quáº£ XSMT") break;
        if (r[0] === "ÄB") continue; // bá» dÃ²ng nhÃ£n ÄB, sá»‘ Ä‘Ã£ náº±m á»Ÿ dÃ²ng ngay trÆ°á»›c Ä‘Ã³
        for (let c = 1; c < r.length; c++) {
          const v = r[c];
          if (v === undefined || v === null || v === "") continue;
          const n = parseInt(v, 10);
          if (!Number.isNaN(n)) nums.push(((n % 100) + 100) % 100);
        }
      }
      return nums;
    }

    // Core logic: táº§n suáº¥t 3 ngÃ y (manual-only)
    function pick5ByFreq3Days(dayArrays, nBets = 5) {
      if (dayArrays.length < 3) throw new Error("Cáº§n Ä‘á»§ 3 ngÃ y trÆ°á»›c.");
      const freq = new Map();
      dayArrays.forEach(arr => {
        arr.forEach(n => {
          const num = ((n % 100) + 100) % 100;
          freq.set(num, (freq.get(num) || 0) + 1);
        });
      });

      if (freq.size === 0) return sample(range(100), nBets);

      const items = Array.from(freq.entries());
      shuffle(items); // tie-break ngáº«u nhiÃªn
      items.sort((a, b) => b[1] - a[1]);

      let picks = items.slice(0, nBets).map(([n]) => n);
      if (picks.length < nBets) {
        const used = new Set(picks);
        const candidates = range(100).filter(x => !used.has(x));
        shuffle(candidates);
        picks = picks.concat(candidates.slice(0, nBets - picks.length));
      }
      return picks;
    }

    // ===== UI handling =====
    const inputDate = document.getElementById("target-date");
    const labelD1 = document.getElementById("label-d1");
    const labelD2 = document.getElementById("label-d2");
    const labelD3 = document.getElementById("label-d3");
    const helper = document.getElementById("date-helper");
    const inputD1 = document.getElementById("input-d1");
    const inputD2 = document.getElementById("input-d2");
    const inputD3 = document.getElementById("input-d3");
    const output = document.getElementById("output");
    const btnRun = document.getElementById("btn-run");
    const excelUrlInput = document.getElementById("excel-url");
    const excelStatus = document.getElementById("excel-status");
    const btnLoadExcel = document.getElementById("btn-load-excel");
    const btnD1 = document.getElementById("btn-d1");
    const btnD2 = document.getElementById("btn-d2");
    const btnD3 = document.getElementById("btn-d3");
    const panelD1 = document.getElementById("panel-d1");
    const panelD2 = document.getElementById("panel-d2");
    const panelD3 = document.getElementById("panel-d3");
    const countD1 = document.getElementById("count-d1");
    const countD2 = document.getElementById("count-d2");
    const countD3 = document.getElementById("count-d3");

    function setExcelStatus(text, isError = false) {
      if (!excelStatus) return;
      excelStatus.textContent = text;
      excelStatus.style.color = isError ? "#fca5a5" : "var(--muted)";
    }

    function togglePanel(btn, panel) {
      if (!btn || !panel) return;
      const isOpen = panel.classList.toggle("open");
      if (isOpen) {
        panel.classList.add("open");
        btn.classList.add("active");
      } else {
        panel.classList.remove("open");
        btn.classList.remove("active");
      }
    }

    function updateCounts() {
      const c1 = parseNums(inputD1.value).length;
      const c2 = parseNums(inputD2.value).length;
      const c3 = parseNums(inputD3.value).length;
      if (countD1) countD1.textContent = c1;
      if (countD2) countD2.textContent = c2;
      if (countD3) countD3.textContent = c3;
      if (btnD1) btnD1.classList.toggle("ready", c1 > 0);
      if (btnD2) btnD2.classList.toggle("ready", c2 > 0);
      if (btnD3) btnD3.classList.toggle("ready", c3 > 0);
    }

    function updateLabels() {
      const d = parseDateDDMMYYYY(inputDate.value);
      if (!d) {
        labelD1.textContent = "D-1:";
        labelD2.textContent = "D-2:";
        labelD3.textContent = "D-3:";
        helper.textContent = "D-1: ?, D-2: ?, D-3: ?";
        return;
      }
      const d1 = new Date(d); d1.setDate(d1.getDate() - 1);
      const d2 = new Date(d); d2.setDate(d2.getDate() - 2);
      const d3 = new Date(d); d3.setDate(d3.getDate() - 3);
      labelD1.textContent = `D-1 ${formatDDMMYYYY(d1)}:`;
      labelD2.textContent = `D-2 ${formatDDMMYYYY(d2)}:`;
      labelD3.textContent = `D-3 ${formatDDMMYYYY(d3)}:`;
      helper.textContent = `D-1: ${formatDDMMYYYY(d1)}, D-2: ${formatDDMMYYYY(d2)}, D-3: ${formatDDMMYYYY(d3)}`;
    }

    function setOutput(text) {
      output.value = text;
    }

    async function onLoadExcel() {
      if (!excelUrlInput) return;
      const url = excelUrlInput.value.trim();
      if (!url) {
        setExcelStatus("Nhập raw URL file Excel trên GitHub.", true);
        return;
      }

      const d = parseDateDDMMYYYY(inputDate.value);
      if (!d) {
        setExcelStatus("Ngày mục tiêu sai định dạng dd/mm/yyyy.", true);
        return;
      }

      setExcelStatus("Đang tải Excel...");
      const d1 = new Date(d); d1.setDate(d1.getDate() - 1);
      const d2 = new Date(d); d2.setDate(d2.getDate() - 2);
      const d3 = new Date(d); d3.setDate(d3.getDate() - 3);

      try {
        const wb = await fetchExcel(url);
        const arrD3 = extractNumsForDate(wb, d3);
        const arrD2 = extractNumsForDate(wb, d2);
        const arrD1 = extractNumsForDate(wb, d1);
        const statusParts = [
          `D-3: ${arrD3.length} sá»‘`,
          `D-2: ${arrD2.length} sá»‘`,
          `D-1: ${arrD1.length} sá»‘`,
        ];

        if (arrD3.length) inputD3.value = toTextareaString(arrD3);
        if (arrD2.length) inputD2.value = toTextareaString(arrD2);
        if (arrD1.length) inputD1.value = toTextareaString(arrD1);
        updateCounts();

        if (!arrD1.length && !arrD2.length && !arrD3.length) {
          setExcelStatus("Không thấy dữ liệu 3 ngày trong file. Nhập tay giúp nhé.", true);
        } else {
          setExcelStatus(`Đã nạp từ Excel (${statusParts.join(", ")}). Kiểm tra lại trước khi tính.`);
        }
        updateLabels();
      } catch (err) {
        setExcelStatus(`Lỗi nạp Excel: ${err.message}`, true);
      }
    }

    function onRun() {
      updateLabels();
      const d = parseDateDDMMYYYY(inputDate.value);
      if (!d) {
        setOutput("Sai Ä‘á»‹nh dáº¡ng ngÃ y, dÃ¹ng dd/mm/yyyy.");
        return;
      }

      const arrD1 = parseNums(inputD1.value);
      const arrD2 = parseNums(inputD2.value);
      const arrD3 = parseNums(inputD3.value);

      const missing = [];
      if (!arrD1.length) missing.push("D-1");
      if (!arrD2.length) missing.push("D-2");
      if (!arrD3.length) missing.push("D-3");
      if (missing.length) {
        setOutput(`Thiáº¿u dá»¯ liá»‡u: ${missing.join(", ")}. HÃ£y nháº­p sá»‘ cho Ä‘á»§ 3 ngÃ y trÆ°á»›c.`);
        return;
      }

      const picks = pick5ByFreq3Days([arrD3, arrD2, arrD1], 5);
      const picksFmt = picks.map(n => String(n).padStart(2, "0")).join(", ");

      const lines = [
        `NgÃ y ${formatDDMMYYYY(d)} Ä‘á» xuáº¥t 5 cáº·p:`,
        picksFmt,
        "",
        "Nguá»“n dá»¯ liá»‡u:",
        `- D-3 ${labelD3.textContent.replace(":", "")} (${arrD3.length} sá»‘)`,
        `- D-2 ${labelD2.textContent.replace(":", "")} (${arrD2.length} sá»‘)`,
        `- D-1 ${labelD1.textContent.replace(":", "")} (${arrD1.length} sá»‘)`,
      ];
      setOutput(lines.join("\n"));
    }

    inputDate.addEventListener("keyup", updateLabels);
    inputDate.addEventListener("change", updateLabels);
    inputDate.addEventListener("blur", updateLabels);
    if (btnD3 && panelD3) btnD3.addEventListener("click", () => togglePanel(btnD3, panelD3));
    if (btnD2 && panelD2) btnD2.addEventListener("click", () => togglePanel(btnD2, panelD2));
    if (btnD1 && panelD1) btnD1.addEventListener("click", () => togglePanel(btnD1, panelD1));
    if (inputD1) inputD1.addEventListener("input", updateCounts);
    if (inputD2) inputD2.addEventListener("input", updateCounts);
    if (inputD3) inputD3.addEventListener("input", updateCounts);
    if (btnLoadExcel) btnLoadExcel.addEventListener("click", onLoadExcel);
    btnRun.addEventListener("click", onRun);
    document.getElementById("btn-index").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    updateLabels();
    updateCounts();
  </script>
</body>
</html>







